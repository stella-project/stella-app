name: stella

networks:
  stella-shared:
    external: true
    name: stella-shared

services:
  app:
    build: ./web
    volumes:
        - ./data:/data
    expose:
      - "8000"
    ports:
        - "8080:8000"
    networks:
      stella-shared:
        aliases:
          - stella-app
    environment:
      # Config
        - FLASK_APP=app/app
        - FLASK_CONFIG=postgres
        - INTERLEAVE=True
        - BULK_INDEX=False
        - DELETE_SENT_SESSION=True
        - INTERVAL_DB_CHECK=3
        - SESSION_EXPIRATION=6

      # Systems
        - RECSYS_LIST=mock_rec_base mock_rec_experiment
        - RECSYS_BASE=mock_rec_base
        - RANKSYS_LIST=gesis_rank_pyserini_base gesis_rank_pyserini
        - RANKSYS_BASE=gesis_rank_pyserini_base
      
      # Stella Server
        - STELLA_SERVER_ADDRESS=http://stella-server:8000
        - STELLA_SERVER_USER=site@stella-project.org
        - STELLA_SERVER_PASS=pass
        - STELLA_SERVER_USERNAME=LIVIVO
            
      # Database
        - POSTGRES_USER=postgres
        - POSTGRES_PW=change-me
        - POSTGRES_DB=postgres
        - POSTGRES_URL=db:5430
    command: gunicorn -w 2 --timeout 60 -b :8000 'app.app:create_app()'
    depends_on:
      - db-app


  db-app:
    image: postgres
    ports:
      - 5430:5430
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=change-me
      - POSTGRES_DB=postgres
    command: -p 5430
    networks:
        - stella-shared


  gesis_rank_pyserini_base:
    build: https://github.com/stella-project/gesis_rank_pyserini_base.git#main
    container_name: gesis_rank_pyserini_base
    volumes:
        - ./data/:/data/
    networks:
        - stella-shared

  gesis_rank_pyserini:
    build: https://github.com/stella-project/gesis_rank_pyserini.git#main
    container_name: gesis_rank_pyserini
    volumes:
        - ./data/:/data/
    networks:
        - stella-shared
  
  mock_rec_base:
    build: https://github.com/zbmed-semtec/mock_rec_base.git#main
    container_name: mock_rec_base
    volumes:
        - ./data/:/data/
    networks:
        - stella-shared

  mock_rec_experiment:
    build: https://github.com/zbmed-semtec/mock_rec_experiment.git#main
    container_name: mock_rec_experiment
    volumes:
        - ./data/:/data/
    networks:
        - stella-shared
